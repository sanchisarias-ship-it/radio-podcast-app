<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>üéß Radio & Podcast App</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f172a">

<style>
:root {
  --bg: #0f172a;
  --panel: #111827;
  --card: #1f2937;
  --accent: #22c55e;
  --accent2: #38bdf8;
  --text: #e5e7eb;
  --muted: #9ca3af;
  --danger: #ef4444;
}
* { box-sizing: border-box; }
body { margin:0; font-family: system-ui, Arial; background: linear-gradient(180deg,#020617,#0f172a); color: var(--text); }
header { padding:16px; text-align:center; font-weight:700; background: rgba(2,6,23,.7); position:sticky; top:0; backdrop-filter: blur(6px); z-index:10;}
nav { display:flex; gap:6px; padding:10px; background: rgba(2,6,23,.7); position:sticky; top:56px; z-index:9;}
nav button { flex:1; padding:12px; border-radius:14px; border:1px solid #1f2937; background:#020617; color:white; }
nav button.active { background: linear-gradient(135deg,#22c55e,#38bdf8); color:black; font-weight:700;}
.section { display:none; padding:14px;}
.section.active { display:block;}
.card { background: rgba(31,41,55,.85); border:1px solid #1f2937; border-radius:18px; padding:14px; margin-bottom:12px;}
.row { display:flex; gap:8px; flex-wrap:wrap;}
input,button { padding:12px; border-radius:14px; border:1px solid #1f2937; background:#020617; color:white;}
button.primary { background: linear-gradient(135deg,#22c55e,#38bdf8); color:black; font-weight:700;}
.list { display:grid; gap:10px;}
.item { background:#020617; border:1px solid #1f2937; border-radius:16px; padding:12px;}
.player { position:sticky; bottom:0; background: rgba(2,6,23,.95); padding:12px; border-top:1px solid #1f2937;}
audio { width:100%; }
.actions { display:flex; gap:6px; flex-wrap:wrap;}
.group { border:1px dashed #1f2937; border-radius:16px; padding:10px; margin-bottom:10px;}
.episode { background:#020617; border:1px solid #1f2937; border-radius:14px; padding:10px; margin-top:8px;}
.muted { color:#9ca3af; font-size:14px;}
</style>
</head>
<body>

<header>üéß Radio & Podcast App</header>

<nav>
  <button onclick="show('radios')" class="active">Radios</button>
  <button onclick="show('podcasts')">Podcasts</button>
  <button onclick="show('favoritos')">Favoritos</button>
</nav>

<div id="radios" class="section active">
  <div class="card">
    <h3>üîç Buscar radios en Internet</h3>
    <div class="row">
      <input id="radioQuery" placeholder="Los 40, SER, rock, Valencia...">
      <button class="primary" onclick="searchRadiosOnline()">Buscar</button>
    </div>
    <div id="radioResults" class="list"></div>
  </div>
  <div id="radioList" class="list"></div>
</div>

<div id="podcasts" class="section">
  <div class="card">
    <h3>üîç Buscar podcasts reales (con episodios)</h3>
    <div class="row">
      <input id="podcastQuery" placeholder="misterio, psicolog√≠a, Nadie Sabe Nada...">
      <button class="primary" onclick="searchPodcastsOnline()">Buscar</button>
    </div>
    <div id="podcastResults" class="list"></div>
  </div>
  <div id="programList"></div>
</div>

<div id="favoritos" class="section">
  <div class="card">
    <h3>‚≠ê Favoritos</h3>
    <div id="favList" class="list"></div>
  </div>
</div>

<div class="player">
  <div id="playerTitle"><strong>Nada en reproducci√≥n</strong></div>
  <audio id="player" controls></audio>
</div>

<script>
const proxy = "https://api.allorigins.win/raw?url=";

/* NAV */
function show(id){
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
  event.target.classList.add('active');
}

/* PLAYER */
const player = document.getElementById("player");
function play(url,title){
  document.getElementById("playerTitle").innerHTML = "<strong>"+title+"</strong>";
  player.src = url;
  player.play();
}

/* STORAGE */
const get=(k,d=[])=>JSON.parse(localStorage.getItem(k)||JSON.stringify(d));
const set=(k,v)=>localStorage.setItem(k,JSON.stringify(v));

/* RADIO SEARCH */
async function searchRadiosOnline(){
  const q = radioQuery.value.trim();
  if(!q) return;
  radioResults.innerHTML="<div class='muted'>Buscando...</div>";
  try{
    const url = proxy + encodeURIComponent("https://de1.api.radio-browser.info/json/stations/search?name="+q+"&limit=15");
    const res = await fetch(url);
    const data = await res.json();
    radioResults.innerHTML="";
    data.forEach(r=>{
      const div=document.createElement("div");
      div.className="item";
      div.innerHTML=`
        <strong>${r.name}</strong>
        <p class='muted'>${r.country||""}</p>
        <div class='actions'>
          <button onclick="play('${r.url}','${r.name}')">‚ñ∂</button>
          <button onclick="saveRadio('${r.name}','${r.url}')">üíæ Guardar</button>
        </div>`;
      radioResults.appendChild(div);
    });
  }catch(e){
    radioResults.innerHTML="<div class='muted'>Error de conexi√≥n.</div>";
  }
}

function saveRadio(name,url){
  const radios=get("radios");
  radios.push({name,url});
  set("radios",radios);
  renderRadios();
}

function renderRadios(){
  radioList.innerHTML="";
  get("radios").forEach(r=>{
    const div=document.createElement("div");
    div.className="item";
    div.innerHTML=`<strong>${r.name}</strong><button onclick="play('${r.url}','${r.name}')">‚ñ∂</button>`;
    radioList.appendChild(div);
  });
}

/* PODCAST SEARCH WITH RSS */
async function searchPodcastsOnline(){
  const q = podcastQuery.value.trim();
  if(!q) return;
  podcastResults.innerHTML="<div class='muted'>Buscando programas...</div>";
  try{
    const url = proxy + encodeURIComponent("https://itunes.apple.com/search?media=podcast&term="+q+"&limit=10");
    const res = await fetch(url);
    const data = await res.json();
    podcastResults.innerHTML="";

    for(const p of data.results){
      const div=document.createElement("div");
      div.className="item";
      div.innerHTML=`
        <strong>${p.collectionName}</strong>
        <p class='muted'>${p.artistName}</p>
        <button onclick="loadEpisodes('${p.feedUrl.replace(/'/g,"")}','${p.collectionName.replace(/'/g,"")}')">Ver episodios</button>`;
      podcastResults.appendChild(div);
    }
  }catch(e){
    podcastResults.innerHTML="<div class='muted'>Error al buscar podcasts.</div>";
  }
}

async function loadEpisodes(feedUrl,title){
  podcastResults.innerHTML="<div class='muted'>Cargando episodios...</div>";
  try{
    const url = proxy + encodeURIComponent(feedUrl);
    const res = await fetch(url);
    const text = await res.text();
    const parser = new DOMParser();
    const xml = parser.parseFromString(text,"text/xml");
    const items = Array.from(xml.querySelectorAll("item")).slice(0,10);

    const group=document.createElement("div");
    group.className="group";
    group.innerHTML="<h3>"+title+"</h3>";

    items.forEach(i=>{
      const title=i.querySelector("title")?.textContent||"Episodio";
      const enclosure=i.querySelector("enclosure")?.getAttribute("url");
      if(!enclosure) return;

      const ep=document.createElement("div");
      ep.className="episode";
      ep.innerHTML=`
        <strong>${title}</strong>
        <div class="actions">
          <button onclick="play('${enclosure}','${title}')">‚ñ∂</button>
        </div>`;
      group.appendChild(ep);
    });

    podcastResults.innerHTML="";
    podcastResults.appendChild(group);
  }catch(e){
    podcastResults.innerHTML="<div class='muted'>No se pudieron cargar los episodios.</div>";
  }
}

/* FAVORITOS */
function favItem(name,url){
  const favs=get("favs");
  favs.push({name,url});
  set("favs",favs);
  renderFavs();
}
function renderFavs(){
  favList.innerHTML="";
  get("favs").forEach(f=>{
    const div=document.createElement("div");
    div.className="item";
    div.innerHTML=`<strong>${f.name}</strong><button onclick="play('${f.url}','${f.name}')">‚ñ∂</button>`;
    favList.appendChild(div);
  });
}

renderRadios();
renderFavs();
</script>

</body>
</html>
