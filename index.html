<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>üéß Radio & Podcast App</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f172a">

<style>
:root {
  --bg: #0f172a;
  --panel: #111827;
  --card: #1f2937;
  --accent: #22c55e;
  --accent2: #38bdf8;
  --text: #e5e7eb;
  --muted: #9ca3af;
  --danger: #ef4444;
}

* { box-sizing: border-box; }

body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
  background: linear-gradient(180deg, #020617, #0f172a);
  color: var(--text);
}

header {
  padding: 16px;
  text-align: center;
  font-weight: 700;
  letter-spacing: .5px;
  background: rgba(2,6,23,.6);
  position: sticky;
  top: 0;
  z-index: 10;
  backdrop-filter: blur(6px);
}

nav {
  display: flex;
  gap: 6px;
  padding: 10px;
  background: rgba(2,6,23,.6);
  position: sticky;
  top: 56px;
  z-index: 9;
  backdrop-filter: blur(6px);
}

nav button {
  flex: 1;
  padding: 12px;
  border-radius: 14px;
  border: 1px solid #1f2937;
  background: #020617;
  color: var(--text);
  font-weight: 600;
}

nav button.active {
  background: linear-gradient(135deg, #22c55e, #38bdf8);
  color: #020617;
}

.section { display: none; padding: 14px; }
.section.active { display: block; }

.card {
  background: rgba(31,41,55,.85);
  border: 1px solid #1f2937;
  border-radius: 18px;
  padding: 14px;
  margin-bottom: 12px;
  box-shadow: 0 10px 30px rgba(0,0,0,.25);
}

.row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }

input, select, button {
  padding: 12px;
  border-radius: 14px;
  border: 1px solid #1f2937;
  background: #020617;
  color: var(--text);
}

button.primary { background: linear-gradient(135deg, #22c55e, #38bdf8); color: #020617; font-weight: 700; }
button.ghost { background: transparent; }
button.danger { border-color: #3f1d1d; background: #160a0a; color: #fecaca; }

.list { display: grid; grid-template-columns: 1fr; gap: 10px; }

.item {
  background: #020617;
  border: 1px solid #1f2937;
  border-radius: 16px;
  padding: 12px;
}

.item h4 { margin: 0 0 6px 0; }
.muted { color: var(--muted); font-size: 14px; }

.player {
  position: sticky;
  bottom: 0;
  background: rgba(2,6,23,.92);
  backdrop-filter: blur(8px);
  border-top: 1px solid #1f2937;
  padding: 12px;
}

.player .title { font-weight: 700; }
.player .sub { font-size: 13px; color: var(--muted); }

audio { width: 100%; }

.actions { display: flex; gap: 6px; flex-wrap: wrap; }

.small { font-size: 13px; }

.searchbox { margin-bottom: 10px; }

.group {
  border: 1px dashed #1f2937;
  border-radius: 18px;
  padding: 10px;
  margin-bottom: 10px;
}

.group-title { font-weight: 800; display: flex; justify-content: space-between; align-items: center; }
.episode { padding: 10px; border-radius: 14px; border: 1px solid #1f2937; margin-top: 8px; background: #020617; }

.badge { font-size: 12px; background: #0b1220; padding: 4px 8px; border-radius: 999px; border: 1px solid #1f2937; }
</style>
</head>

<body>

<header>üéß Radio & Podcast App</header>

<nav>
  <button onclick="show('radios')" class="active">Radios</button>
  <button onclick="show('podcasts')">Podcasts</button>
  <button onclick="show('favoritos')">Favoritos</button>
</nav>

<!-- RADIOS -->
<div id="radios" class="section active">
  <div class="card">
    <h3>üìª Emisoras</h3>

    <div class="searchbox">
      <input id="searchRadios" placeholder="üîç Buscar emisora..." onkeyup="renderRadios()">
    </div>

    <div class="row">
      <input id="radioName" placeholder="Nombre">
      <input id="radioUrl" placeholder="URL del stream">
      <button class="primary" onclick="addRadio()">A√±adir</button>
    </div>

    <div class="row small">
      <span class="muted">Ordenar:</span>
      <select id="radioSort" onchange="renderRadios()">
        <option value="name">Nombre</option>
        <option value="date">Fecha de a√±adido</option>
      </select>
    </div>
  </div>

  <div id="radioList" class="list"></div>
</div>

<!-- PODCASTS -->
<div id="podcasts" class="section">
  <!-- NUEVO: A√ëADIR PODCAST R√ÅPIDO (igual que radios) -->
  <div class="card">
    <h3>‚ûï A√±adir podcast (r√°pido)</h3>
    <div class="row">
      <input id="quickProgram" placeholder="Nombre del programa">
      <input id="quickTitle" placeholder="T√≠tulo del episodio">
      <input id="quickUrl" placeholder="URL del episodio (mp3)">
      <button class="primary" onclick="quickAddPodcast()">A√±adir</button>
    </div>
    <p class="muted small">Esto crea autom√°ticamente el programa si no existe.</p>
  </div>

  <div class="card">
    <h3>üéôÔ∏è Podcasts (por programas)</h3>

    <div class="searchbox">
      <input id="searchPodcasts" placeholder="üîç Buscar programa o episodio..." onkeyup="renderPrograms()">
    </div>

    <div class="row">
      <input id="programName" placeholder="Nombre del programa">
      <button class="primary" onclick="addProgram()">Crear programa</button>
    </div>
  </div>

  <div id="programList"></div>
</div>

<!-- FAVORITOS -->
<div id="favoritos" class="section">
  <div class="card">
    <h3>‚≠ê Favoritos</h3>
    <div id="favList" class="list"></div>
  </div>
</div>

<!-- PLAYER -->
<div class="player">
  <div class="title" id="playerTitle">Nada en reproducci√≥n</div>
  <div class="sub" id="playerSub"></div>

  <div class="row">
    <span class="badge">Velocidad</span>
    <select id="speedControl" onchange="setSpeed()">
      <option value="0.75">0.75x</option>
      <option value="1" selected>1x</option>
      <option value="1.25">1.25x</option>
      <option value="1.5">1.5x</option>
      <option value="2">2x</option>
    </select>
  </div>

  <audio id="player" controls></audio>
</div>

<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}

function show(id) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
}

const player = document.getElementById("player");

function play(url, title, sub) {
  document.getElementById("playerTitle").innerText = title || "Reproduciendo";
  document.getElementById("playerSub").innerText = sub || "";
  player.src = url;
  player.play();
  saveLastTrack(url, title, sub);
}

function setSpeed() {
  player.playbackRate = parseFloat(speedControl.value);
  localStorage.setItem("playbackRate", speedControl.value);
}

player.addEventListener("timeupdate", () => {
  if (player.src) {
    localStorage.setItem("lastTime_" + player.src, player.currentTime);
  }
});

player.addEventListener("loadedmetadata", () => {
  const t = localStorage.getItem("lastTime_" + player.src);
  if (t) player.currentTime = parseFloat(t);
});

function saveLastTrack(url, title, sub) {
  localStorage.setItem("lastTrack", JSON.stringify({url, title, sub}));
}

function restoreLastTrack() {
  const data = JSON.parse(localStorage.getItem("lastTrack") || "null");
  if (data) {
    play(data.url, data.title, data.sub);
    player.pause();
  }
  const rate = localStorage.getItem("playbackRate");
  if (rate) {
    speedControl.value = rate;
    player.playbackRate = parseFloat(rate);
  }
}

const get = (k, d=[]) => JSON.parse(localStorage.getItem(k) || JSON.stringify(d));
const set = (k, v) => localStorage.setItem(k, JSON.stringify(v));

/* RADIOS */
function addRadio() {
  const name = radioName.value.trim();
  const url = radioUrl.value.trim();
  if (!name || !url) return;
  const radios = get("radios");
  radios.push({id: Date.now(), name, url, created: Date.now()});
  set("radios", radios);
  radioName.value = "";
  radioUrl.value = "";
  renderRadios();
}

function deleteRadio(id) {
  let radios = get("radios");
  radios = radios.filter(r => r.id !== id);
  set("radios", radios);
  renderRadios();
}

function renderRadios() {
  const list = document.getElementById("radioList");
  const search = document.getElementById("searchRadios").value.toLowerCase();
  const sort = document.getElementById("radioSort").value;
  let radios = get("radios");
  radios = radios.filter(r => r.name.toLowerCase().includes(search));
  radios.sort((a,b) => sort === "name" ? a.name.localeCompare(b.name) : b.created - a.created);
  list.innerHTML = "";
  radios.forEach(r => {
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <h4>${r.name}</h4>
      <div class="actions">
        <button onclick="play('${r.url}','${r.name}','Radio en directo')">‚ñ∂</button>
        <button onclick="favItem('${r.name}','${r.url}')">‚≠ê</button>
        <button class="danger" onclick="deleteRadio(${r.id})">üóë</button>
      </div>`;
    list.appendChild(div);
  });
}

/* PODCASTS */
function addProgram() {
  const name = programName.value.trim();
  if (!name) return;
  const programs = get("programs");
  programs.push({id: Date.now(), name, episodes: []});
  set("programs", programs);
  programName.value = "";
  renderPrograms();
}

function quickAddPodcast() {
  const prog = quickProgram.value.trim();
  const title = quickTitle.value.trim();
  const url = quickUrl.value.trim();
  if (!prog || !title || !url) return;

  const programs = get("programs");
  let p = programs.find(x => x.name.toLowerCase() === prog.toLowerCase());
  if (!p) {
    p = {id: Date.now(), name: prog, episodes: []};
    programs.push(p);
  }
  p.episodes.push({id: Date.now(), title, url, created: Date.now()});
  set("programs", programs);

  quickProgram.value = "";
  quickTitle.value = "";
  quickUrl.value = "";

  renderPrograms();
}

function addEpisode(programId) {
  const title = document.getElementById("epTitle_"+programId).value.trim();
  const url = document.getElementById("epUrl_"+programId).value.trim();
  if (!title || !url) return;
  const programs = get("programs");
  const p = programs.find(x => x.id === programId);
  p.episodes.push({id: Date.now(), title, url, created: Date.now()});
  set("programs", programs);
  renderPrograms();
}

function deleteEpisode(programId, epId) {
  const programs = get("programs");
  const p = programs.find(x => x.id === programId);
  p.episodes = p.episodes.filter(e => e.id !== epId);
  set("programs", programs);
  renderPrograms();
}

function deleteProgram(programId) {
  let programs = get("programs");
  programs = programs.filter(p => p.id !== programId);
  set("programs", programs);
  renderPrograms();
}

function renderPrograms() {
  const wrap = document.getElementById("programList");
  const search = document.getElementById("searchPodcasts").value.toLowerCase();
  const programs = get("programs");
  wrap.innerHTML = "";

  programs.forEach(p => {
    const matchesProgram = p.name.toLowerCase().includes(search);
    const epMatches = p.episodes.filter(e => e.title.toLowerCase().includes(search));
    if (!matchesProgram && epMatches.length === 0 && search !== "") return;

    const group = document.createElement("div");
    group.className = "group";
    group.innerHTML = `
      <div class="group-title">
        <span>${p.name}</span>
        <button class="danger small" onclick="deleteProgram(${p.id})">Eliminar programa</button>
      </div>
      <div class="card">
        <input id="epTitle_${p.id}" placeholder="T√≠tulo del episodio">
        <input id="epUrl_${p.id}" placeholder="URL del episodio (mp3)">
        <button class="primary" onclick="addEpisode(${p.id})">A√±adir episodio</button>
      </div>`;

    p.episodes.sort((a,b)=> b.created - a.created).forEach(e => {
      const ep = document.createElement("div");
      ep.className = "episode";
      ep.innerHTML = `
        <strong>${e.title}</strong>
        <div class="actions">
          <button onclick="play('${e.url}','${e.title}','${p.name}')">‚ñ∂</button>
          <button onclick="favItem('${e.title}','${e.url}')">‚≠ê</button>
          <button class="danger" onclick="deleteEpisode(${p.id},${e.id})">üóë</button>
          <button onclick="downloadEpisode('${e.url}')">‚¨á Descargar</button>
        </div>`;
      group.appendChild(ep);
    });

    wrap.appendChild(group);
  });
}

/* FAVORITOS */
function favItem(name, url) {
  const favs = get("favs");
  if (!favs.find(f => f.name === name)) {
    favs.push({name, url});
    set("favs", favs);
    renderFavs();
  }
}

function renderFavs() {
  const list = document.getElementById("favList");
  const favs = get("favs");
  list.innerHTML = "";
  favs.forEach(f => {
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <h4>${f.name}</h4>
      <button onclick="play('${f.url}','${f.name}','Favorito')">‚ñ∂ Escuchar</button>`;
    list.appendChild(div);
  });
}

async function downloadEpisode(url) {
  if (!navigator.serviceWorker.controller) {
    alert("Recarga la app para activar descargas offline.");
    return;
  }
  navigator.serviceWorker.controller.postMessage({ action: "cache-audio", url });
  alert("Episodio guardado para escuchar sin conexi√≥n.");
}

renderRadios();
renderPrograms();
renderFavs();
restoreLastTrack();
</script>

</body>
</html>
