<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>ðŸŽ§ Podcast</title>
<meta name="theme-color" content="#111111">

<style>
:root{
  --bg:#0b0b0b;
  --card:#141414;
  --border:#222;
  --accent:#f43f5e;
  --text:#f5f5f5;
  --muted:#a1a1aa;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial;
  background:var(--bg);
  color:var(--text);
  padding-bottom:120px;
}
header{position:sticky;top:0;background:#000;padding:16px;text-align:center;font-weight:800;font-size:18px;z-index:10}
.section{padding:14px}
.card{background:var(--card);border:1px solid var(--border);border-radius:22px;padding:16px;margin-bottom:14px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
input,button,a{padding:10px 14px;border-radius:999px;border:1px solid var(--border);background:#000;color:#fff;text-decoration:none;font-size:14px}
button.primary{background:var(--accent);color:#000;font-weight:800}
button.small{padding:6px 12px;font-size:12px}
.list{display:grid;gap:10px}
.item{background:#000;border:1px solid var(--border);border-radius:18px;padding:12px}
.actions{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
.muted{color:var(--muted);font-size:14px}

.player{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  background:#000;
  border-top:1px solid var(--border);
  padding:12px;
  z-index:999;
}

audio{width:100%}
.programHeader{display:flex;align-items:center;gap:6px}
.programHeader strong{flex:1}
.loading{color:#facc15;font-size:13px}
.error{color:#fca5a5;font-size:13px}

.spin { animation: spin 1s linear infinite; }
@keyframes spin { from {transform:rotate(0deg)} to {transform:rotate(360deg)} }
</style>
</head>
<body>

<header>ðŸŽ§ Podcast</header>

<section class="section">
  <div class="card">
    <h3>ðŸ”Ž Buscar podcasts</h3>
    <div class="row">
      <input id="podQ" placeholder="Buscar podcast..." style="flex:1">
      <button class="primary" onclick="searchPods()">Buscar</button>
    </div>
    <div id="podResults" class="list"></div>
  </div>

  <div class="card">
    <h3>ðŸ“š Mis programas</h3>
    <div id="programList"></div>
  </div>
</section>

<div class="player">
  <strong id="playerTitle">Nada en reproducciÃ³n</strong>
  <audio id="player" controls playsinline></audio>
</div>

<script>
const player = document.getElementById("player");
const store=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
const load=(k,d=[])=>JSON.parse(localStorage.getItem(k)||JSON.stringify(d));
const esc = s => String(s||"").replace(/'/g,"");

const PROXIES = [
  url => "https://api.allorigins.win/raw?url=" + encodeURIComponent(url),
  url => "https://cors.isomorphic-git.org/" + url
];

let currentEpisodeId = null;

function play(url,title,id){
  currentEpisodeId = id;
  player.src=url;
  document.getElementById("playerTitle").textContent=title;

  const saved = localStorage.getItem("pos_"+id);
  player.onloadedmetadata = () => {
    if(saved && !isNaN(saved)) player.currentTime = Number(saved);
  };

  player.play().catch(()=>{});

  if ('mediaSession' in navigator) {
    navigator.mediaSession.metadata = new MediaMetadata({
      title: title,
      artist: "Podcast",
      album: "Mi App"
    });
    navigator.mediaSession.setActionHandler('play', () => player.play());
    navigator.mediaSession.setActionHandler('pause', () => player.pause());
  }
}

player.addEventListener("timeupdate",()=>{
  if(currentEpisodeId){
    localStorage.setItem("pos_"+currentEpisodeId, player.currentTime);
  }
});

async function searchPods(){
  const q = podQ.value.trim(); if(!q) return;
  podResults.innerHTML="<div class='muted'>Buscandoâ€¦</div>";
  const results=[];
  await Promise.allSettled([searchApple(q,results), searchPI(q,results), searchFyyd(q,results)]);
  podResults.innerHTML="";
  if(!results.length){ podResults.innerHTML="<div class='muted'>Sin resultados.</div>"; return; }

  const existing = load("programs").map(p=>p.feedUrl);
  results.forEach(p=>{
    const added = existing.includes(p.feedUrl);
    const div=document.createElement("div");
    div.className="item";
    div.innerHTML=`<strong>${p.title}</strong>
      <p class="muted">${p.author||""}</p>
      <button ${added?"disabled":""} onclick="addProgram('${esc(p.feedUrl)}','${esc(p.title)}')">
        ${added?"âœ” AÃ±adido":"âž• AÃ±adir"}
      </button>`;
    podResults.appendChild(div);
  });
}

async function searchApple(q,arr){
  try{
    const res = await fetch("https://api.allorigins.win/raw?url="+encodeURIComponent("https://itunes.apple.com/search?media=podcast&term="+q+"&limit=20"));
    const data = await res.json();
    data.results.forEach(p=>p.feedUrl && arr.push({title:p.collectionName,author:p.artistName,feedUrl:p.feedUrl}));
  }catch{}
}
async function searchPI(q,arr){
  try{
    const res = await fetch("https://api.allorigins.win/raw?url="+encodeURIComponent("https://api.podcastindex.org/api/1.0/search/byterm?q="+q));
    const data = await res.json();
    (data.feeds||[]).slice(0,20).forEach(p=>p.url && arr.push({title:p.title,author:p.author,feedUrl:p.url}));
  }catch{}
}
async function searchFyyd(q,arr){
  try{
    const res = await fetch("https://api.allorigins.win/raw?url="+encodeURIComponent("https://api.fyyd.de/0.2/search/podcast?term="+q));
    const data = await res.json();
    (data.data||[]).slice(0,15).forEach(p=>p.xmlURL && arr.push({title:p.title,author:p.author,feedUrl:p.xmlURL}));
  }catch{}
}

function addProgram(feedUrl,title){
  let programs = load("programs");
  if(programs.some(p=>p.feedUrl===feedUrl)) return;
  programs.push({title,feedUrl,episodes:[],open:true,loading:true,error:false});
  store("programs",programs);
  renderPrograms();
  loadEpisodes(feedUrl,true);
}

async function loadEpisodes(feedUrl,initial=false){
  let text=null;
  for(const make of PROXIES){
    try{
      const res = await fetch(make(feedUrl));
      text = await res.text();
      if(text && text.includes("<item")) break;
    }catch{}
  }

  let programs=load("programs");
  const p=programs.find(x=>x.feedUrl===feedUrl);

  if(!text){
    p.loading=false; p.error=true;
    store("programs",programs); renderPrograms(); return;
  }

  try{
    const xml = new DOMParser().parseFromString(text,"text/xml");
    const items=[...xml.querySelectorAll("item")];

    const episodes = items.map(i=>{
      const guid = i.querySelector("guid")?.textContent;
      const url = i.querySelector("enclosure")?.getAttribute("url");
      const title = i.querySelector("title")?.textContent || "Episodio";
      const id = btoa((guid || url || title));
      return { id, title, url, date:new Date(i.querySelector("pubDate")?.textContent||Date.now()).getTime() };
    }).filter(e=>e.url);

    const prevCount = p.episodes.length;
    p.episodes = episodes.sort((a,b)=>b.date-a.date);

    if(!initial && episodes.length > prevCount){
      alert("ðŸ“¢ Nuevos episodios en " + p.title);
    }

    p.loading=false; p.error=false;
    store("programs",programs);
    renderPrograms();
  }catch{
    p.loading=false; p.error=true;
    store("programs",programs);
    renderPrograms();
  }
}

function refreshProgram(feedUrl,btn){
  if(btn) btn.classList.add("spin");
  loadEpisodes(feedUrl,false).finally(()=>{
    if(btn) btn.classList.remove("spin");
  });
}

function toggleProgram(feedUrl){
  let programs=load("programs");
  const p=programs.find(x=>x.feedUrl===feedUrl);
  p.open=!p.open;
  store("programs",programs);
  renderPrograms();
}

function deleteProgram(feedUrl){
  let programs=load("programs").filter(p=>p.feedUrl!==feedUrl);
  store("programs",programs);
  renderPrograms();
}

function togglePlayed(id){
  const key="played_"+id;
  if(localStorage.getItem(key)==="1"){ localStorage.removeItem(key); }
  else { localStorage.setItem(key,"1"); }
  renderPrograms();
}

function deleteEpisode(programFeed,id){
  let programs=load("programs");
  const p=programs.find(x=>x.feedUrl===programFeed);
  p.episodes = p.episodes.filter(e=>e.id!==id);
  store("programs",programs);
  renderPrograms();
}

function renderPrograms(){
  programList.innerHTML="";
  load("programs").forEach(p=>{
    const box=document.createElement("div");
    box.className="item";
    box.innerHTML=`
      <div class="programHeader">
        <strong>${p.title}</strong>
        <button class="small" onclick="refreshProgram('${esc(p.feedUrl)}',this)">ðŸ”„</button>
        <button class="small" onclick="toggleProgram('${esc(p.feedUrl)}')">${p.open?"â–²":"â–¼"}</button>
        <button class="small" onclick="deleteProgram('${esc(p.feedUrl)}')">ðŸ—‘</button>
      </div>`;

    if(p.open){
      if(p.loading) box.innerHTML += `<div class="loading">Cargando episodiosâ€¦</div>`;
      if(p.error) box.innerHTML += `<div class="error">No se pudieron cargar.</div>`;

      p.episodes.forEach(e=>{
        const played = localStorage.getItem("played_"+e.id)==="1";
        const div=document.createElement("div");
        div.className="item";
        div.innerHTML=`
          ${played?"âœ… ":""}${e.title}
          <div class="actions">
            <button onclick="play('${esc(e.url)}','${esc(e.title)}','${e.id}')">â–¶</button>
            <button onclick="togglePlayed('${e.id}')">${played?"No escuchado":"Escuchado"}</button>
            <a href="${e.url}" target="_blank">â¬‡ Descargar</a>
            <button onclick="deleteEpisode('${esc(p.feedUrl)}','${e.id}')">ðŸ—‘</button>
          </div>`;
        box.appendChild(div);
      });
    }
    programList.appendChild(box);
  });
}

setInterval(()=>{
  load("programs").forEach(p=> loadEpisodes(p.feedUrl,false));
}, 1200000);

renderPrograms();
</script>
</body>
</html>