<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>üéß Podcast</title>
<meta name="theme-color" content="#111111">

<style>
:root{
  --bg:#0b0b0b;
  --card:#141414;
  --border:#222;
  --accent:#f43f5e;
  --text:#f5f5f5;
  --muted:#a1a1aa;
  --danger:#7f1d1d;
}
*{box-sizing:border-box}
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
header{position:sticky;top:0;background:#000;padding:16px;text-align:center;font-weight:800;font-size:18px;z-index:10}
nav{position:sticky;top:56px;display:flex;gap:8px;padding:10px;background:#000;z-index:9}
nav button{flex:1;padding:12px;border-radius:999px;border:1px solid var(--border);background:#000;color:#fff}
nav button.active{background:var(--accent);color:#000;font-weight:800}
.section{display:none;padding:14px}
.section.active{display:block}
.card{background:var(--card);border:1px solid var(--border);border-radius:22px;padding:16px;margin-bottom:14px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
input,button{padding:12px 16px;border-radius:999px;border:1px solid var(--border);background:#000;color:#fff}
button.primary{background:var(--accent);color:#000;font-weight:800}
button.danger{background:#200;color:#fca5a5}
button.small{padding:6px 12px;font-size:12px}
.list{display:grid;gap:10px}
.item{background:#000;border:1px solid var(--border);border-radius:18px;padding:12px}
.actions{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
.muted{color:var(--muted);font-size:14px}
.badge{background:var(--accent);color:#000;border-radius:999px;padding:2px 8px;font-size:12px;font-weight:800}
.player{position:sticky;bottom:0;background:#000;border-top:1px solid var(--border);padding:12px}
audio{width:100%}
.programHeader{display:flex;align-items:center;gap:6px}
.programHeader strong{flex:1}
.loading{color:#facc15;font-size:13px}
.error{color:#fca5a5;font-size:13px}
.progress{height:6px;background:#222;border-radius:999px;overflow:hidden;margin-top:4px}
.progress > div{height:100%;background:var(--accent);width:0%}
</style>
</head>
<body>

<header>üéß Podcast</header>
<nav>
  <button class="active" onclick="show('podcasts',this)">Podcasts</button>
  <button onclick="show('downloads',this)">‚¨á Descargas</button>
  <button onclick="show('favorites',this)">‚≠ê Favoritos</button>
</nav>

<section id="podcasts" class="section active">
  <div class="card">
    <h3>üîé Buscar podcasts</h3>
    <div class="row">
      <input id="podQ" placeholder="Buscar podcast..." style="flex:1">
      <button class="primary" onclick="searchPods()">Buscar</button>
    </div>
    <div id="podResults" class="list"></div>
  </div>

  <div class="card">
    <h3>üìö Mis programas</h3>
    <div id="programList"></div>
  </div>
</section>

<section id="downloads" class="section">
  <div class="card">
    <h3>‚¨á Descargas</h3>
    <div class="muted">Se mantienen desde versiones anteriores.</div>
  </div>
</section>

<section id="favorites" class="section">
  <div class="card">
    <h3>‚≠ê Favoritos</h3>
    <div class="muted">Se mantienen desde versiones anteriores.</div>
  </div>
</section>

<div class="player">
  <strong id="playerTitle">Nada en reproducci√≥n</strong>
  <audio id="player" controls playsinline></audio>
</div>

<script>
const player = document.getElementById("player");
const store=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
const load=(k,d=[])=>JSON.parse(localStorage.getItem(k)||JSON.stringify(d));
const esc = s => String(s||"").replace(/'/g,"");

const PROXIES = [
  url => "https://api.allorigins.win/raw?url=" + encodeURIComponent(url),
  url => "https://cors.isomorphic-git.org/" + url
];

let currentEpisodeId = null;

function show(id,btn){
  document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  document.querySelectorAll("nav button").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
}

function play(url,title,id){
  currentEpisodeId = id;
  player.src=url;
  document.getElementById("playerTitle").textContent=title;

  const saved = localStorage.getItem("pos_"+id);
  player.onloadedmetadata = () => {
    if(saved && !isNaN(saved)) player.currentTime = Number(saved);
  };

  player.play().catch(()=>{});
  localStorage.setItem("played_"+id,"1");
  renderPrograms();
}

player.addEventListener("timeupdate",()=>{
  if(currentEpisodeId){
    localStorage.setItem("pos_"+currentEpisodeId, player.currentTime);
  }
});

/* ===== BUSCADOR ===== */
async function searchPods(){
  const q = podQ.value.trim(); if(!q) return;
  podResults.innerHTML="<div class='muted'>Buscando‚Ä¶</div>";
  const results=[];
  await Promise.allSettled([searchApple(q,results), searchPI(q,results), searchFyyd(q,results)]);
  podResults.innerHTML="";
  if(!results.length){ podResults.innerHTML="<div class='muted'>Sin resultados.</div>"; return; }

  const existing = load("programs").map(p=>p.feedUrl);
  results.forEach(p=>{
    const added = existing.includes(p.feedUrl);
    const div=document.createElement("div");
    div.className="item";
    div.innerHTML=`<strong>${p.title}</strong>
      <p class="muted">${p.author||""}</p>
      <button ${added?"disabled":""} onclick="addProgram('${esc(p.feedUrl)}','${esc(p.title)}')">
        ${added?"‚úî A√±adido":"‚ûï A√±adir a mis programas"}
      </button>`;
    podResults.appendChild(div);
  });
}

async function searchApple(q,arr){
  try{
    const res = await fetch("https://api.allorigins.win/raw?url="+encodeURIComponent("https://itunes.apple.com/search?media=podcast&term="+q+"&limit=20"));
    const data = await res.json();
    data.results.forEach(p=>p.feedUrl && arr.push({title:p.collectionName,author:p.artistName,feedUrl:p.feedUrl}));
  }catch{}
}
async function searchPI(q,arr){
  try{
    const res = await fetch("https://api.allorigins.win/raw?url="+encodeURIComponent("https://api.podcastindex.org/api/1.0/search/byterm?q="+q));
    const data = await res.json();
    (data.feeds||[]).slice(0,20).forEach(p=>p.url && arr.push({title:p.title,author:p.author,feedUrl:p.url}));
  }catch{}
}
async function searchFyyd(q,arr){
  try{
    const res = await fetch("https://api.allorigins.win/raw?url="+encodeURIComponent("https://api.fyyd.de/0.2/search/podcast?term="+q));
    const data = await res.json();
    (data.data||[]).slice(0,15).forEach(p=>p.xmlURL && arr.push({title:p.title,author:p.author,feedUrl:p.xmlURL}));
  }catch{}
}

/* ===== PROGRAMAS ===== */
function addProgram(feedUrl,title){
  let programs = load("programs");
  if(programs.some(p=>p.feedUrl===feedUrl)) return;
  programs.push({title,feedUrl,episodes:[],open:true,loading:true,error:false});
  store("programs",programs);
  renderPrograms();
  loadEpisodes(feedUrl);
  searchPods();
}

async function loadEpisodes(feedUrl){
  let text=null;
  for(const make of PROXIES){
    try{
      const res = await fetch(make(feedUrl));
      text = await res.text();
      if(text && text.includes("<item")) break;
    }catch{}
  }

  let programs=load("programs");
  const p=programs.find(x=>x.feedUrl===feedUrl);

  if(!text){
    p.loading=false; p.error=true;
    store("programs",programs); renderPrograms(); return;
  }

  try{
    const xml = new DOMParser().parseFromString(text,"text/xml");
    const items=[...xml.querySelectorAll("item")];

    p.episodes = items.map(i=>({
      id:btoa(i.querySelector("guid")?.textContent || i.querySelector("title")?.textContent || Math.random()),
      title:i.querySelector("title")?.textContent || "Episodio",
      url:i.querySelector("enclosure")?.getAttribute("url"),
      date: new Date(i.querySelector("pubDate")?.textContent || Date.now()).getTime()
    })).filter(e=>e.url);

    // Ordenar: no escuchados primero y luego por fecha descendente
    p.episodes.sort((a,b)=>{
      const ap = localStorage.getItem("played_"+a.id)==="1";
      const bp = localStorage.getItem("played_"+b.id)==="1";
      if(ap!==bp) return ap - bp;
      return b.date - a.date;
    });

    p.loading=false; p.error=false;
    store("programs",programs);
    renderPrograms();
  }catch{
    p.loading=false; p.error=true;
    store("programs",programs); renderPrograms();
  }
}

function toggleProgram(feedUrl){
  let programs=load("programs");
  const p=programs.find(x=>x.feedUrl===feedUrl);
  p.open=!p.open;
  store("programs",programs);
  renderPrograms();
}

function deleteProgram(feedUrl){
  let programs=load("programs").filter(p=>p.feedUrl!==feedUrl);
  store("programs",programs);
  renderPrograms();
  searchPods();
}

function renderPrograms(){
  programList.innerHTML="";
  load("programs").forEach(p=>{
    const box=document.createElement("div");
    box.className="item";
    box.innerHTML=`
      <div class="programHeader">
        <strong>${p.title}</strong>
        <button class="small" onclick="toggleProgram('${esc(p.feedUrl)}')">${p.open?"‚ñ≤":"‚ñº"}</button>
        <button class="danger small" onclick="deleteProgram('${esc(p.feedUrl)}')">üóë</button>
      </div>`;

    if(p.open){
      if(p.loading) box.innerHTML += `<div class="loading">Cargando episodios‚Ä¶</div>`;
      if(p.error) box.innerHTML += `<div class="error">No se pudieron cargar.</div>`;

      p.episodes.forEach(e=>{
        const played=localStorage.getItem("played_"+e.id)==="1";
        const pos = localStorage.getItem("pos_"+e.id) || 0;
        const div=document.createElement("div");
        div.className="item";
        div.innerHTML=`
          ${played?"‚úÖ ":""}${e.title}
          <div class="progress"><div style="width:${Math.min((pos/3600)*100,100)}%"></div></div>
          <div class="actions">
            <button onclick="play('${esc(e.url)}','${esc(e.title)}','${e.id}')">‚ñ∂</button>
            <a href="${e.url}" target="_blank">‚¨á</a>
          </div>`;
        box.appendChild(div);
      });
    }
    programList.appendChild(box);
  });
}

renderPrograms();
</script>
</body>
</html>