<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>üéß Podcast</title>
<meta name="theme-color" content="#020617">

<style>
:root{
  --bg:#020617; --card:#111827; --border:#1f2937;
  --accent:#22c55e; --accent2:#38bdf8; --text:#e5e7eb; --muted:#9ca3af; --danger:#ef4444;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#020617;color:var(--text)}
header{position:sticky;top:0;background:#020617;padding:14px;text-align:center;font-weight:900;z-index:10}
nav{position:sticky;top:52px;display:flex;gap:6px;padding:10px;background:#020617;z-index:9}
nav button{flex:1;padding:12px;border-radius:16px;border:1px solid var(--border);background:#000;color:#fff}
nav button.active{background:linear-gradient(135deg,#22c55e,#38bdf8);color:#000;font-weight:900}
.section{display:none;padding:14px}
.section.active{display:block}
.card{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:14px;margin-bottom:12px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
input,button{padding:12px;border-radius:16px;border:1px solid var(--border);background:#000;color:#fff}
button.primary{background:linear-gradient(135deg,#22c55e,#38bdf8);color:#000;font-weight:900}
button.danger{background:#2a0000;color:#ffbaba}
button.small{padding:6px 10px;font-size:12px}
.list{display:grid;gap:10px}
.item{background:#000;border:1px solid var(--border);border-radius:18px;padding:12px}
.actions{display:flex;gap:6px;flex-wrap:wrap}
.muted{color:var(--muted);font-size:14px}
.player{position:sticky;bottom:0;background:#020617;border-top:1px solid var(--border);padding:12px}
audio{width:100%}
details summary{cursor:pointer;color:#9ca3af;margin-bottom:6px}
</style>
</head>
<body>

<header>üéß Podcast</header>
<nav>
  <button class="active" onclick="show('podcasts',this)">Podcasts</button>
  <button onclick="show('downloads',this)">‚¨á Descargas</button>
  <button onclick="show('favorites',this)">‚≠ê Favoritos</button>
</nav>

<section id="podcasts" class="section active">
  <div class="card">
    <h3>üîé Buscar podcasts</h3>
    <div class="row">
      <input id="podQ" placeholder="Buscar podcast..." style="flex:1">
      <button class="primary" onclick="searchPods()">Buscar</button>
    </div>

    <details id="searchBox" open>
      <summary>Resultados</summary>
      <div id="podResults" class="list"></div>
    </details>
  </div>

  <div class="card">
    <h3>üìö Mis programas</h3>
    <div id="programList"></div>
  </div>
</section>

<section id="downloads" class="section">
  <div class="card">
    <h3>‚¨á Episodios descargados</h3>
    <div id="downloadsList" class="list"></div>
  </div>
</section>

<section id="favorites" class="section">
  <div class="card">
    <h3>‚≠ê Favoritos</h3>
    <div id="favoritesList" class="list"></div>
  </div>
</section>

<div class="player">
  <strong id="playerTitle">Nada en reproducci√≥n</strong>
  <audio id="player" controls playsinline></audio>
</div>

<script>
const PROXY = "https://api.allorigins.win/raw?url=";
const player = document.getElementById("player");
const store=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
const load=(k,d=[])=>JSON.parse(localStorage.getItem(k)||JSON.stringify(d));

function show(id,btn){
  document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  document.querySelectorAll("nav button").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
}

function play(url,title,id){
  player.src=url;
  player.play();
  document.getElementById("playerTitle").textContent=title;
  if(id) localStorage.setItem("played_"+id,"1");
  renderPrograms(); renderDownloads(); renderFavorites();
}

/* ===== BUSCADOR ===== */
async function searchPods(){
  const q = podQ.value.trim(); if(!q) return;
  podResults.innerHTML="<div class='muted'>Buscando‚Ä¶</div>";
  const results=[];
  await Promise.allSettled([searchApple(q,results), searchPI(q,results), searchFyyd(q,results)]);
  podResults.innerHTML="";
  if(!results.length){ podResults.innerHTML="<div class='muted'>Sin resultados.</div>"; return; }

  const existing = load("programs").map(p=>p.feedUrl);

  results.forEach(p=>{
    const added = existing.includes(p.feedUrl);
    const div=document.createElement("div");
    div.className="item";
    div.innerHTML=`<strong>${p.title}</strong>
      <p class="muted">${p.author||""}</p>
      <button ${added?"disabled":""} onclick="addProgram('${p.feedUrl}','${p.title.replace(/'/g,"")}')">
        ${added?"‚úî A√±adido":"‚ûï A√±adir a mis programas"}
      </button>`;
    podResults.appendChild(div);
  });
}

async function searchApple(q,arr){
  try{
    const res = await fetch(PROXY+encodeURIComponent("https://itunes.apple.com/search?media=podcast&term="+q+"&limit=20"));
    const data = await res.json();
    data.results.forEach(p=>p.feedUrl && arr.push({title:p.collectionName,author:p.artistName,feedUrl:p.feedUrl}));
  }catch{}
}
async function searchPI(q,arr){
  try{
    const res = await fetch(PROXY+encodeURIComponent("https://api.podcastindex.org/api/1.0/search/byterm?q="+q));
    const data = await res.json();
    (data.feeds||[]).slice(0,20).forEach(p=>p.url && arr.push({title:p.title,author:p.author,feedUrl:p.url}));
  }catch{}
}
async function searchFyyd(q,arr){
  try{
    const res = await fetch(PROXY+encodeURIComponent("https://api.fyyd.de/0.2/search/podcast?term="+q));
    const data = await res.json();
    (data.data||[]).slice(0,15).forEach(p=>p.xmlURL && arr.push({title:p.title,author:p.author,feedUrl:p.xmlURL}));
  }catch{}
}

/* ===== PROGRAMAS ===== */
function addProgram(feedUrl,title){
  let programs = load("programs");
  if(programs.some(p=>p.feedUrl===feedUrl)) return;
  programs.push({title,feedUrl,episodes:[],open:false});
  store("programs",programs);
  loadEpisodes(feedUrl);
  searchPods(); // refresca botones a "A√±adido"
}

async function loadEpisodes(feedUrl){
  try{
    const res = await fetch(PROXY+encodeURIComponent(feedUrl));
    const text = await res.text();
    const xml = new DOMParser().parseFromString(text,"text/xml");
    const items=[...xml.querySelectorAll("item")].slice(0,25);

    let programs=load("programs");
    const p=programs.find(x=>x.feedUrl===feedUrl);
    p.episodes=items.map(i=>({
      id:btoa(i.querySelector("title")?.textContent||Math.random()),
      title:i.querySelector("title")?.textContent||"Episodio",
      url:i.querySelector("enclosure")?.getAttribute("url")
    })).filter(e=>e.url);
    store("programs",programs);
    renderPrograms();
  }catch{}
}

function toggleProgram(feedUrl){
  let programs=load("programs");
  const p=programs.find(x=>x.feedUrl===feedUrl);
  p.open=!p.open;
  store("programs",programs);
  renderPrograms();
}

function deleteProgram(feedUrl){
  let programs=load("programs").filter(p=>p.feedUrl!==feedUrl);
  store("programs",programs);
  renderPrograms();
  searchPods();
}

function renderPrograms(){
  programList.innerHTML="";
  load("programs").forEach(p=>{
    const box=document.createElement("div");
    box.className="item";
    box.innerHTML=`
      <div class="row">
        <strong style="flex:1">${p.title}</strong>
        <button class="small" onclick="toggleProgram('${p.feedUrl}')">${p.open?"‚ñ≤":"‚ñº"}</button>
        <button class="danger small" onclick="deleteProgram('${p.feedUrl}')">üóë</button>
      </div>`;

    if(p.open){
      p.episodes.forEach(e=>{
        const played=localStorage.getItem("played_"+e.id)==="1";
        const div=document.createElement("div");
        div.className="item";
        div.innerHTML=`${played?"‚úÖ ":""}${e.title}
          <div class="actions">
            <button onclick="play('${e.url}','${e.title.replace(/'/g,"")}','${e.id}')">‚ñ∂</button>
            <a href="${e.url}" target="_blank" onclick="trackDownload('${e.id}','${e.title.replace(/'/g,"")}','${e.url}')">‚¨á</a>
          </div>`;
        box.appendChild(div);
      });
    }
    programList.appendChild(box);
  });
}

/* ===== DESCARGAS ===== */
function trackDownload(id,title,url){
  let arr=load("downloads");
  if(arr.some(d=>d.id===id)) return;
  arr.push({id,title,url,fav:false});
  store("downloads",arr);
  renderDownloads();
}

function renderDownloads(){
  downloadsList.innerHTML="";
  const arr=load("downloads");
  if(!arr.length){ downloadsList.innerHTML="<div class='muted'>No hay descargas.</div>"; return; }
  arr.forEach(d=>{
    const div=document.createElement("div");
    div.className="item";
    div.innerHTML=`<strong>${d.title}</strong>
      <div class="actions">
        <button onclick="play('${d.url}','${d.title}')">‚ñ∂</button>
        <button onclick="toggleFav('${d.id}')">${d.fav?"‚≠ê":"‚òÜ"}</button>
        <button class="danger" onclick="deleteDownload('${d.id}')">üóë</button>
      </div>`;
    downloadsList.appendChild(div);
  });
}

function deleteDownload(id){
  let arr=load("downloads").filter(d=>d.id!==id);
  store("downloads",arr);
  renderDownloads(); renderFavorites();
}

function toggleFav(id){
  let arr=load("downloads");
  const d=arr.find(x=>x.id===id);
  d.fav=!d.fav;
  store("downloads",arr);
  renderDownloads(); renderFavorites();
}

/* ===== FAVORITOS ===== */
function renderFavorites(){
  favoritesList.innerHTML="";
  const arr=load("downloads").filter(d=>d.fav);
  if(!arr.length){ favoritesList.innerHTML="<div class='muted'>No hay favoritos.</div>"; return; }
  arr.forEach(f=>{
    const div=document.createElement("div");
    div.className="item";
    div.innerHTML=`<strong>${f.title}</strong>
      <div class="actions">
        <button onclick="play('${f.url}','${f.title}')">‚ñ∂</button>
      </div>`;
    favoritesList.appendChild(div);
  });
}

renderPrograms(); renderDownloads(); renderFavorites();
</script>
</body>
</html>